image: ghcr.io/astral-sh/uv:0.4-python3.12-bookworm-slim

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  UV_CACHE_DIR: .uv-cache

default:
  tags:
    - docker

cache:
  paths:
    - $UV_CACHE_DIR

stages:
  - test
  - deploy

pytest_cov:
  stage: test
  script:
    - uv run pytest --cov=. --cov-report xml src/tests
    - uv run coverage report --include="src/fsl_pipe_gui/*.py"
    - uv run coverage html --include="src/fsl_pipe_gui/*.py"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov
  coverage: '/^TOTAL.+?(\d+\%)$/'


python_version:
  image: ghcr.io/astral-sh/uv:0.4-python$VERSION-bookworm-slim
  stage: test
  script:
    - uv run pytest src/tests
  parallel:
    matrix:
      - VERSION: ["3.10", "3.11", "3.12", "3.13"]


to_pypi:
  stage: deploy
  script:
    - uv build
    - uv publish --token=${CI_JOB_TOKEN}
  only:
    - tags
