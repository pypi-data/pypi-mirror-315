
variables:
  UV_CACHE_DIR: .uv-cache

default:
  image: ghcr.io/astral-sh/uv:0.4-python3.12-bookworm-slim
  tags:
    - docker

cache:
  paths:
    - $UV_CACHE_DIR

stages:
  - test
  - deploy

pytest_cov:
  stage: test
  script:
    - uv run pytest --cov=. --cov-report xml src/tests
    - uv run coverage report --include="src/file_tree/*.py"
    - uv run coverage html --include="src/file_tree/*.py"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov
  coverage: '/^TOTAL.+?(\d+\%)$/'

python_version:
  stage: test
  image: ghcr.io/astral-sh/uv:0.4-python$VERSION-bookworm-slim
  script:
    - uv run pytest src/tests
  parallel:
    matrix:
      - VERSION: ["3.10", "3.11", "3.12", "3.13"]

build_test:
  stage: test
  script:
    - uv run sphinx-build doc/source doc/build
    - uv build

pages:
  stage: deploy
  script:
    - uv run sphinx-build doc/source doc/build
    - mv doc/build public
    - uv run pytest --cov=. --cov-report xml src/tests
    - uv run coverage html --include="src/file_tree/*.py"
    - mv htmlcov public/.
  artifacts:
    paths:
      - public
  only:
    - master


to_pypi:
  stage: deploy
  script:
    - uv build
    - uv publish --token ${CI_JOB_TOKEN}
  only:
    - tags
