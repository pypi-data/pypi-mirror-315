image: python:3.11

definitions:
  steps:
    - step: &lint
        caches:
          - pip
        name: Lint
        script:
          - pip install -U pip setuptools wheel
          - pip install pre-commit
          - pre-commit install
          - pre-commit run --all-files

    - step: &scan
        caches:
          - pip
        name: Scan
        script:
          - pip install -U pip setuptools wheel
          - pip install .
          - pip freeze | grep -v @ > requirements.txt
          - cat requirements.txt
          - echo $SNYK_VERSION
          - curl -L -o snyk https://github.com/snyk/snyk/releases/download/$SNYK_VERSION/snyk-linux
          - chmod 755 snyk
          - ./snyk -d auth $SNYK_TOKEN
          - echo $SNYK_IGNORE
          - for id in $SNYK_IGNORE; do echo Ignoring $id; ./snyk ignore $id; done
          - cat .snyk || echo "No .snyk found. Probably because there was nothing to ignore."
          - echo $SNYK_CLI_COMMAND
          - $SNYK_CLI_COMMAND

    - step: &test311
        caches:
          - pip
        name: Test Python 3.11
        script:
          - pip install -U pip
          - pip install tox
          - tox -e py311

          # Upload test coverage to codecov
          - curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
          - curl -Os https://uploader.codecov.io/latest/linux/codecov
          - curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
          - curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig
          - gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
          - shasum -a 256 -c codecov.SHA256SUM
          - chmod +x codecov
          - ./codecov -t ${CODECOV_TOKEN}

    - step: &test310
        image: python:3.10
        caches:
          - pip
        name: Test Python 3.10
        script:
          - pip install -U pip
          - pip install tox
          - tox run -e py310

    - step: &test310-min
        image: python:3.10
        caches:
          - pip
        name: Test Python 3.10 - Minimum
        script:
          - pip install -U pip
          - pip install tox
          - tox run -e py310-min

    - step: &push
        caches:
          - pip
        name: Push
        script:
          - pip install -U pip
          - pip install twine build
          - python -m build --outdir wheelhouse .
          - python -m twine upload --skip-existing wheelhouse/*

pipelines:
  default:
    - step: *lint
    - parallel:
      - step: *test311
      - step: *test310
      - step: *test310-min
    - step: *scan
  tags:
    'v*':
    - parallel:
      - step: *lint
      - step: *test311
      - step: *test310
      - step: *test310-min
      - step: *scan
    - step: *push
