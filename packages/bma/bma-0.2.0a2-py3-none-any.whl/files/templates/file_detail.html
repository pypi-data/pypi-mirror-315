{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load pictures %}
{% load humanize %}
{% block title %}File details{% endblock title %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/vendor/plyr-v3.7.8.css' %}">
<script src="{% static "js/vendor/plyr-v3.7.8.js" %}"></script>
<script src="{% static "js/plyr.js" %}"></script>
<link rel="stylesheet" href="{% static 'css/vendor/photoswipe-v5.4.4.css' %}">
<link rel="stylesheet" href="{% static 'css/vendor/photoswipe-dynamic-caption-plugin-v1.2.7.css' %}">
{% endblock extra_head %}

{% block main_content %}
  <div class="row">
    <div class="col mb-3 mb-xl-0">
      {% block file_detail %}
      {% endblock file_detail %}
    </div>

    <!-- Sidebar start -->
    <div class="col-xl-3 col-12">
      <div class="row">
        <div class="col mb-3">
          <div class="card">
            <div class="card-header">
                <h5 class="card-title">{{ file.filetype|capfirst }} Information<a class="btn btn-secondary btn-xs float-end" href="{% url 'files:file_show' file_uuid=file.uuid %}"><i class="{{ file.filetype_icon }}"></i> Show {{ file.filetype|capfirst }}</a></h5>
            </div>
            <div class="card-body">
              <div class="row justfiy-content-between">
                <div class="col-12">
                  <dl class="row mb-1">
                    <h5>License &amp; Attribution</h5>
                    <small class="d-block">Title</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.title }}</div>

                    <small class="d-block">Attribution</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.attribution }}</div>

                    <small class="d-block">Source</small>
                    <div class="ms-2 mb-1 fw-bolder"><a href="{{ file.source }}">{{ file.source }}</a></div>

                    <small class="d-block">License</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.get_license_display }}</div>

                    <h5 class="mt-3">Download</h5>
                    <small class="d-block">Original File</small>
                    <div class="ms-2 mb-1 fw-bolder"><a href="{{ file.original.url }}"><i class="fas fa-download"></i> download</a> ({{ file.file_size|intcomma }} bytes {{ file.mimetype }})</div>

                    <h5 class="mt-3">Metadata</h5>
                    <small class="d-block">Description</small>
                    <div class="ms-2 mb-1 fw-bolder">{% if file.description %}<p>{{ file.description }}</p>{% else %}N/A{% endif %}</div>

                    <small class="d-block">Uploader</small>
                    <div class="ms-2 mb-1 fw-bolder"><a href="{{ file.uploader.get_absolute_url }}">{{ file.uploader }}</a></div>

                    <small class="d-block">BMA UUID</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.uuid }}</div>

                    <small class="d-block">Hits</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.hits.count }}</div>

                    <small class="d-block">Original Filename</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.original_filename }}</div>

                    <small class="d-block">Created (uploaded)</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.created_at }}</div>

                    <small class="d-block">Updated</small>
                    <div class="ms-2 mb-1 fw-bolder">{{ file.updated_at }}</div>

                    <small class="d-block">Jobs</small>
                    <div class="ms-2 mb-1 fw-bolder"><a class="btn btn-secondary btn-sm" href="{% url 'files:file_jobs' file_uuid=file.uuid %}">Show {{ file.jobs.count }} jobs</a></div>
                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- thumbnails -->
      <div class="row">
        <div class="col mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">{{ file.filetype|capfirst }} Thumbnails<a class="btn btn-secondary btn-xs float-end" href="{% url 'files:file_thumbnails' file_uuid=file.uuid %}"><i class="fas fa-table-cells-large"></i> Show Thumbnails</a></h5>
            </div>
            <div class="card-body">
              <div class="row justfiy-content-between">
                <div class="col-12">
                  <table class="table table-responsive table-small">
                    <thead>
                      <tr><th>Ratio</th><th>Mimetype</th><th>Sizes</th></tr>
                    </thead>
                    <tbody>
                    {% for ratio, filetypes in file.get_thumbnails.items %}
                    {% for filetype, sizes in filetypes.items %}
                      <tr>
                        <td>{{ ratio|default:"Default" }}</td>
                        <td>{{ filetype }}</td>
                        <td>{% for width, thumbnail in sizes.items %}<a title="{{ thumbnail.imagefile.size|intcomma }} bytes" href="{{ thumbnail.imagefile.url }}">{{ width }}*{{ thumbnail.height }}</a> {% endfor %}</td>
                      </tr>
                    {% endfor %}
                    {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- image versions -->
      {% if file.filetype == "image" %}
      <div class="row">
        <div class="col mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Image Versions</h5>
            </div>
            <div class="card-body">
                <p>Original: <a href="{{ file.original.url }}">{{ file.width }}*{{ file.height }} AR {{ file.aspect_ratio }}</a> ({{ file.file_size|intcomma }} bytes {{ file.mimetype }})</p>
              <table class="table table-responsive table-small">
                <thead>
                  <tr><th>Ratio</th><th>Mimetype</th><th>Sizes</th></tr>
                </thead>
                <tbody>
                {% for ratio, mimetypes in file.get_versions.items %}
                  {% for mimetype, sizes in mimetypes.items %}
                  <tr>
                    <td>{{ ratio|default:"Default" }}</td>
                    <td>{{ mimetype }}</td>
                    <td>{% for width, version in sizes.items %}<a title="{{ version.imagefile.size|intcomma }} bytes" href="{{ version.imagefile.url }}">{{ width }}*{{ version.height }}</a> {% endfor %}</td>
                  </tr>
                  {% endfor %}
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Albums -->
      <div class="row">
        <div class="col mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Albums<a class="btn btn-secondary btn-xs float-end" href="{% url 'files:file_albums' file_uuid=file.uuid %}"><i class="fas fa-list"></i> Show Albums</a></h5>
            </div>
            <div class="card-body" style="max-height:25em; overflow-y:auto;">
              {% for album in file.active_albums_list %}
                <p><a href="{% url 'albums:album_detail' album_uuid=album.uuid %}">{{ album }}</a></p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Tags -->
      <div class="row">
        <div class="col mb-3">
          <div id="tag-card" class="card">
            <div class="card-header">
                <h5 class="card-title">Tags<a class="btn btn-secondary btn-xs float-end" href="{% url 'files:file_tags' file_uuid=file.uuid %}"><i class="fas fa-list"></i> Show Tags</a></h5>
            </div>
            <div class="card-body" style="max-height:25em; overflow-y:auto;">
              {% if file.tags.exists %}
              <p>
                {% if request.user.is_curator %}
                {% for tag in file.tags.all %}
                  {% if request.user.uuid in tag.tagger_uuids %}
                  <form method="POST" action="{% url 'files:file_tag_delete' file_uuid=file.pk tag_slug=tag.slug %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary btn-sm" value="DELETE">{{ tag }} <i class="fas fa-minus"></i></button>
                  </form>
                  {% else %}
                  <form method="POST" action="{% url 'files:file_tag_create' file_uuid=file.pk %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="tags" value='"{{ tag.name }}"'>
                    <button type="submit" class="btn btn-secondary btn-sm">{{ tag }} <i class="fas fa-plus"></i></button>
                  </form>
                  {% endif %}
                {% endfor %}
                {% endif %}
              </p>
              <p><i>Click to tag or untag an existing tag. You can also <a href="{% url 'files:file_tag_create' file_uuid=file.uuid %}">add new tags</a></i></p>
              {% else %}
              <p>No tags yet. <a class="btn btn-success" href="{% url 'files:file_tag_create' file_uuid=file.uuid %}"><i class="fas fa-plus"></i> Add new tags</a></p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>


      {% if file.filetype == "image" and file.exif %}
      <div class="row">
        <div class="col mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Image Exif Data</h5>
            </div>
            <div class="card-body">
              <div class="row justfiy-content-between">
                <div class="col-12">
                  <pre>{{ file.exif | pprint }}</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
<script type="module" src="{% static 'js/photoswipe.js' %}"></script>
{% endblock main_content %}
