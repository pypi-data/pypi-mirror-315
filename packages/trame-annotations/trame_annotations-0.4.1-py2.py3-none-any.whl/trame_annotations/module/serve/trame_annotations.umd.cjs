(function(C,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(C=typeof globalThis<"u"?globalThis:C||self,e(C.trame_annotations={},C.Vue))})(this,function(C,e){"use strict";function z(h){return e.getCurrentScope()?(e.onScopeDispose(h),!0):!1}function M(){const h=e.ref(1);if(window){let t=function(){h.value=window.devicePixelRatio,n(),o=window.matchMedia(`(resolution: ${h.value}dppx)`),o.addEventListener("change",t,{once:!0})},n=function(){o==null||o.removeEventListener("change",t)},o;t(),z(n)}return{pixelRatio:h}}function A(h){const t=e.ref();let n=null,o;const s=()=>{n&&(n.disconnect(),n=null),o=void 0},c=()=>{n=new ResizeObserver(d=>{const l=d[d.length-1],{width:p,height:f,top:u,left:w}=l.target.getBoundingClientRect();t.value={width:p,height:f,top:u,left:w}})};return e.watchEffect(()=>{if(o&&(!h.value||h.value!==o)&&s(),!h.value)return;n||c(),o=h.value,n==null||n.observe(o);const{width:d,height:l,top:p,left:f}=o.getBoundingClientRect();t.value={width:d,height:l,top:p,left:f}}),z(s),t}function W(h,t,n,o,s=8,c=16){const d=A(h);return e.computed(()=>{var v;const p=t.value;let f=p.x+s,u=p.y+s;if(!d.value||!n.value)return{left:f,top:u};const w=d.value,x=((v=o.value)==null?void 0:v.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},b={left:f-x.left,top:u-x.top,width:w.width+c,height:w.height+c};b.left+b.width>x.width&&(f=p.x-w.width-s),f<x.left&&(f=x.left),b.top+b.height>x.height&&(u=p.y-w.height-s),u<x.top&&(u=x.top);const S=n.value.getBoundingClientRect();return f-=S.left,u-=S.top,{left:f,top:u}})}const D=h=>{const t=e.ref(!1);return e.onMounted(()=>{t.value=!0}),e.computed(()=>{const o=e.unref(h);return!t.value||!o?null:document.querySelector(o)})},V=[255,0,0],T=[[0,255,0],[0,0,255],[255,165,0],[0,255,255],[255,255,0],[255,0,255],[255,69,0],[255,20,147],[255,215,0]];class _{constructor(t,n=0){this.bounds={x:t.x||0,y:t.y||0,width:t.width,height:t.height},this.maxObjects=typeof t.maxObjects=="number"?t.maxObjects:10,this.maxLevels=typeof t.maxLevels=="number"?t.maxLevels:4,this.level=n,this.objects=[],this.nodes=[]}getIndex(t){return t.qtIndex(this.bounds)}split(){const t=this.level+1,n=this.bounds.width/2,o=this.bounds.height/2,s=this.bounds.x,c=this.bounds.y,d=[{x:s+n,y:c},{x:s,y:c},{x:s,y:c+o},{x:s+n,y:c+o}];for(let l=0;l<4;l++)this.nodes[l]=new _({x:d[l].x,y:d[l].y,width:n,height:o,maxObjects:this.maxObjects,maxLevels:this.maxLevels},t)}insert(t){if(this.nodes.length){const n=this.getIndex(t);for(let o=0;o<n.length;o++)this.nodes[n[o]].insert(t);return}if(this.objects.push(t),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let n=0;n<this.objects.length;n++){const o=this.getIndex(this.objects[n]);for(let s=0;s<o.length;s++)this.nodes[o[s]].insert(this.objects[n])}this.objects=[]}}retrieve(t){const n=this.getIndex(t);let o=this.objects;if(this.nodes.length)for(let s=0;s<n.length;s++)o=o.concat(this.nodes[n[s]].retrieve(t));return this.level===0?Array.from(new Set(o)):o}remove(t,n=!1){const o=this.objects.indexOf(t);o>-1&&this.objects.splice(o,1);for(let s=0;s<this.nodes.length;s++)this.nodes[s].remove(t);return this.level===0&&!n&&this.join(),o!==-1}update(t,n=!1){this.remove(t,n),this.insert(t)}join(){let t=Array.from(this.objects);for(let o=0;o<this.nodes.length;o++){const s=this.nodes[o].join();t=t.concat(s)}const n=Array.from(new Set(t));if(n.length<=this.maxObjects){this.objects=n;for(let o=0;o<this.nodes.length;o++)this.nodes[o].objects=[];this.nodes=[]}return t}clear(){this.objects=[];for(let t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]}}class L{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.data=t.data}qtIndex(t){const n=[],o=t.x+t.width/2,s=t.y+t.height/2,c=this.y<s,d=this.x<o,l=this.x+this.width>o,p=this.y+this.height>s;return c&&l&&n.push(0),d&&c&&n.push(1),d&&p&&n.push(2),l&&p&&n.push(3),n}}const P=e.defineComponent({__name:"AnnotationPopup",props:{popupAnnotations:{},popupPosition:{},relativeParent:{},container:{}},setup(h){const t=h,{popupAnnotations:n,popupPosition:o,relativeParent:s,container:c}=e.toRefs(t),d=e.ref(),l=W(d,o,s,c);return(p,f)=>(e.openBlock(),e.createElementBlock("ul",{ref_key:"labelContainer",ref:d,style:e.normalizeStyle({position:"absolute",visibility:e.unref(n).length?"visible":"hidden",left:`${e.unref(l).left}px`,top:`${e.unref(l).top}px`,zIndex:10,padding:"0.4rem",whiteSpace:"pre",fontSize:"small",borderRadius:"0.2rem",borderColor:"rgba(127, 127, 127, 0.75)",borderStyle:"solid",borderWidth:"thin",backgroundColor:"white",listStyleType:"none",pointerEvents:"none",margin:0})},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(n),u=>(e.openBlock(),e.createElementBlock("li",{key:u.id,style:{display:"flex",alignItems:"center"}},[e.createElementVNode("span",{style:e.normalizeStyle({backgroundColor:`rgb(${u.color.join(",")})`,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block",marginRight:"0.4rem"})},null,4),e.createElementVNode("span",null,e.toDisplayString(u.name),1)]))),128))],4))}}),q=e.defineComponent({__name:"BoxAnnotations",props:{boxAnnotations:{},imageSize:{},lineWidth:{},lineOpacity:{},popupContainer:{}},setup(h){const t=h,{boxAnnotations:n,lineWidth:o,lineOpacity:s}=e.toRefs(t),c=e.ref(),d=e.computed(()=>{var r;return(r=c.value)==null?void 0:r.getContext("2d",{alpha:!0})}),l=e.ref(),p=e.computed(()=>{var r;return(r=l.value)==null?void 0:r.getContext("2d",{willReadFrequently:!0})}),f=M(),u=A(c),w=e.computed(()=>u.value?t.imageSize.width/u.value.width:1),x=e.computed(()=>o.value*f.pixelRatio.value*w.value);e.watchEffect(()=>{if(!c.value||!d.value)return;const r=c.value,a=d.value;r.width=t.imageSize.width,r.height=t.imageSize.height,a.clearRect(0,0,r.width,r.height),a.globalCompositeOperation="lighter",a.lineWidth=x.value;const i=s.value;t.boxAnnotations.forEach(({color:m,bbox:g})=>{a.strokeStyle=`rgba(${[...m,i].join(",")})`,a.strokeRect(g[0],g[1],g[2],g[3])})});let b;e.watchEffect(()=>{if(!l.value||!p.value)return;const r=l.value,a=p.value;r.width=t.imageSize.width,r.height=t.imageSize.height,a.clearRect(0,0,r.width,r.height),b=new _({width:r.width,height:r.height,maxLevels:8,maxObjects:10}),t.boxAnnotations.forEach((i,m)=>{const g=new L({x:i.bbox[0],y:i.bbox[1],width:i.bbox[2],height:i.bbox[3],data:m});b.insert(g),a.fillStyle="rgb(255, 0, 0)",a.fillRect(i.bbox[0],i.bbox[1],i.bbox[2],i.bbox[3])})});function S(r,a,i){const{left:m,width:g,top:y,height:B}=i.getBoundingClientRect();return[i.width*(r-m)/g,i.height*(a-y)/B]}const v=e.ref(),O=e.computed(()=>v.value?{x:v.value.clientX,y:v.value.clientY}:{x:0,y:0});function E(r,a){return a.x>=r.x+r.width||r.x>=a.x+a.width?!1:!(a.y>=r.y+r.height||r.y>=a.y+a.height)}const $=e.computed(()=>{if(!l.value||l.value.width===0||!b||!n.value||!p.value)return[];const{x:r,y:a}=O.value,[i,m]=S(r,a,l.value),g=new L({x:i,y:m,width:2,height:2});return b.retrieve(g).filter(y=>E(y,g)).map(y=>y.data).filter(y=>y!=null).map(y=>n.value[y])}),k=e.ref(!1),j=e.computed(()=>k.value?$.value:[]);return(r,a)=>(e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:c,style:{width:"100%",position:"absolute",left:"0",top:"0"}},null,512),e.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:l,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0"},onMouseenter:a[0]||(a[0]=i=>k.value=!0),onMouseleave:a[1]||(a[1]=i=>k.value=!1),onMousemove:a[2]||(a[2]=i=>v.value=i)},null,544),e.createVNode(P,{"popup-annotations":j.value,"popup-position":O.value,"relative-parent":l.value,container:r.popupContainer},null,8,["popup-annotations","popup-position","relative-parent","container"])],64))}}),I=6,R=14,Y=e.defineComponent({__name:"ClassificationAnnotations",props:{classifications:{},popupContainer:{}},setup(h){const t=h,n=e.ref(!1),o=e.ref(),s=e.computed(()=>{if(!o.value||!n.value)return{x:0,y:0};const{left:l,top:p,width:f,height:u}=o.value.getBoundingClientRect();return{x:l+f/2,y:p+u-4}}),c=e.computed(()=>t.classifications.length?t.classifications.map(({color:l})=>`rgb(${l.join(",")})`).reverse():[]),d=e.computed(()=>n.value?t.classifications:[]);return(l,p)=>(e.openBlock(),e.createElementBlock("div",{ref_key:"classesDot",ref:o,style:e.normalizeStyle([{position:"relative",margin:"0"},{height:`${c.value.length*I+R}px`,width:`${R}px`}]),onMouseenter:p[0]||(p[0]=f=>n.value=!0),onMouseleave:p[1]||(p[1]=f=>n.value=!1)},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(c.value,(f,u)=>(e.openBlock(),e.createElementBlock("span",{key:u,style:e.normalizeStyle({top:`${c.value.length*I-u*I}px`,position:"absolute",backgroundColor:f,width:`${R}px`,height:`${R}px`,borderRadius:"50%",boxShadow:"0 1px 1px rgba(0, 0, 0, 0.5)"})},null,4))),128)),e.createVNode(P,{"popup-annotations":d.value,"popup-position":s.value,"relative-parent":o.value,container:l.popupContainer},null,8,["popup-annotations","popup-position","relative-parent","container"])],36))}}),H=["src"],F=.9,G=2,X={ImageDetection:e.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},containerSelector:{},lineWidth:{},lineOpacity:{},selected:{},scoreThreshold:{}},emits:["hover"],setup(h,{emit:t}){const n=h,o=e.computed(()=>e.unref(n.annotations)??[]),s=e.computed(()=>e.unref(n.categories)??{}),c=e.computed(()=>e.unref(n.containerSelector)??""),d=e.computed(()=>e.unref(n.lineOpacity)??F),l=e.computed(()=>e.unref(n.lineWidth)??G),p=e.computed(()=>e.unref(n.scoreThreshold)??0),f=e.ref({width:0,height:0}),u=e.ref(),w=()=>{var i,m;f.value={width:((i=u.value)==null?void 0:i.naturalWidth)??0,height:((m=u.value)==null?void 0:m.naturalHeight)??0}},x=e.computed(()=>o.value.filter(({score:i})=>i==null||i>=p.value).map(i=>{var N;const{category_id:m,label:g,score:y}=i,B=m!=null?T[m%T.length]:V,Z=((N=s.value[m])==null?void 0:N.name)??g??"Unknown",J=y!=null?` ${Math.round(y*100)}%`:"",K=`${Z}${J}`;return{...i,color:B,name:K}})),b=e.computed(()=>x.value.reduce((i,m)=>("bbox"in m?i.boxAnnotations.push(m):i.classifications.push(m),i),{boxAnnotations:[],classifications:[]})),S=e.computed(()=>b.value.boxAnnotations),v=e.computed(()=>b.value.classifications),O=t,E=e.ref(!1);function $(){const i=e.unref(n.identifier);i!=null&&O("hover",{id:i}),E.value=!0}function k(){O("hover",{id:""}),E.value=!1}const j=D(c),r=e.computed(()=>n.selected?"4":"0"),a=e.computed(()=>e.unref(n.src)??void 0);return(i,m)=>(e.openBlock(),e.createElementBlock("div",{style:{position:"relative"},onMouseenter:$,onMouseleave:k},[e.createElementVNode("img",{ref_key:"img",ref:u,src:a.value,style:e.normalizeStyle([{outlineWidth:r.value+"px"},{width:"100%","outline-style":"dotted","outline-color":"red"}]),onLoad:w},null,44,H),e.createVNode(q,{"box-annotations":S.value,"image-size":f.value,"line-width":l.value,"line-opacity":d.value,"popup-container":e.unref(j)},null,8,["box-annotations","image-size","line-width","line-opacity","popup-container"]),e.createVNode(Y,{style:{position:"absolute",top:"0.4rem",left:"0.4rem",margin:"0"},classifications:v.value,"popup-container":e.unref(j)},null,8,["classifications","popup-container"])],32))}})};function U(h){Object.entries(X).forEach(([t,n])=>{h.component(t,n)})}C.install=U,Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_annotations.umd.cjs.map
