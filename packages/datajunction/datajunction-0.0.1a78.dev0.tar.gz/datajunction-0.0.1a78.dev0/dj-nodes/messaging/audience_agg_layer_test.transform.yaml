display_name: audience_agg_layer_test
description: 'TEST ONLY. This is for aggregation layer for audience metrics. '
query: |-
  SELECT
    utc_date,
    signup_country_iso_code,
    is_in_member_cnt,
    is_in_paid_member_cnt,
    paying_plan_rollup_id,
    COUNT(DISTINCT profile_id) AS active_profiles,
    COUNT(DISTINCT CASE WHEN email_reachable = 1 OR verified_phone = 1 THEN profile_id END) AS reachable_profiles,
    COUNT(DISTINCT CASE WHEN email_reachable = 1 THEN profile_id END) AS email_reachable_profiles,
    COUNT(DISTINCT CASE WHEN verified_phone = 1 THEN profile_id END) AS push_reachable_profiles,
    COUNT(DISTINCT CASE WHEN (email_category_consent_details.WatchRecommendations_allowed = 1 AND email_category_consent_details.WhatYouWatch_allowed = 1)
                        OR (push_category_consent_details.WatchRecommendations_allowed = 1 AND push_category_consent_details.WhatYouWatch_allowed = 1)
                   THEN profile_id END) AS eligible_profiles,
    COUNT(DISTINCT CASE WHEN email_category_consent_details.WatchRecommendations_allowed = 1 AND email_category_consent_details.WhatYouWatch_allowed = 1
                   THEN profile_id END) AS email_eligible_profiles,
    COUNT(DISTINCT CASE WHEN push_category_consent_details.WatchRecommendations_allowed = 1 AND push_category_consent_details.WhatYouWatch_allowed = 1
                   THEN profile_id END) AS push_eligible_profiles
  FROM
    source.prodhive.msg_dev.metron_msg_profile_sum_with_dev
  WHERE utc_date = NF_DATEINT(DJ_LOGICAL_TIMESTAMP())
  GROUP BY
    utc_date,
    signup_country_iso_code,
    is_in_member_cnt,
    is_in_paid_member_cnt,
    paying_plan_rollup_id
columns:
- name: utc_date
  attributes:
  - dimension
- name: signup_country_iso_code
  attributes:
  - dimension
- name: is_in_member_cnt
  attributes:
  - dimension
- name: is_in_paid_member_cnt
  attributes:
  - dimension
- name: paying_plan_rollup_id
  attributes:
  - dimension
primary_key: []
dimension_links: []
tags: []
