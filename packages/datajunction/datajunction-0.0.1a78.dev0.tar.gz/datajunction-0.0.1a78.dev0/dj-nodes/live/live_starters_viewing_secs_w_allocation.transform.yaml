display_name: live_starters_viewing_secs_w_allocation
description: ''
query: "(SELECT  obs_window.observation_window,\n\talloc.test_id,\n\talloc.alloc_group_id,\n\
  \talloc.test_cell_nbr,\n\talloc.account_id,\n\tIF(alloc.days_since_allocation >=\
  \ obs_window.window_end - 1, 1, 0) AS is_window_complete,\n\tplf.title_id,\n\tlst.show_desc,\n\
  \tCAST(SUM(IF(plf.playback_start_time < nf_from_unixtime(lst.live_event_end_utc_ms_ts)\
  \ AND coalesce(is_supplemental_playback, 0) = 0, viewing_secs['media_clock']['content'],\
  \ 0)) AS BIGINT) AS live_content_viewing_secs,\n\tCAST(SUM(IF(plf.playback_start_time\
  \ < NF_DATEADD('day', 4, nf_from_unixtime(lst.live_event_end_utc_ms_ts)) AND coalesce(is_supplemental_playback,\
  \ 0) = 0, viewing_secs['media_clock']['content'], 0)) AS BIGINT) AS live_plus_96h_content_viewing_secs,\n\
  \tCAST(SUM(IF(plf.playback_start_time < NF_DATEADD('day', 7, nf_from_unixtime(lst.live_event_end_utc_ms_ts))\
  \ AND coalesce(is_supplemental_playback, 0) = 0, viewing_secs['media_clock']['content'],\
  \ 0)) AS BIGINT) AS live_plus_168h_content_viewing_secs,\n\tCAST(SUM(IF(plf.playback_start_time\
  \ < NF_DATEADD('day', 28, nf_from_unixtime(lst.live_event_end_utc_ms_ts)) AND coalesce(is_supplemental_playback,\
  \ 0) = 0, viewing_secs['media_clock']['content'], 0)) AS BIGINT) AS live_plus_28d_content_viewing_secs\n\
  \ FROM source.prodhive.exp_data.allocation_core_d AS alloc CROSS JOIN common.dimensions.xp.observation_window\
  \ obs_window\nINNER JOIN source.prodhive.dse.playback_live_f AS plf ON plf.account_id\
  \ = alloc.account_id AND FLOOR((nf_to_unixtime_ms(NF_DATEADD('hour', plf.playback_start_utc_hour,\
  \ NF_TIMESTAMP(plf.playback_start_utc_date))) - alloc.alloc_utc_ms_ts) / 86400000.0)\
  \ BETWEEN obs_window.window_start - 1 AND obs_window.window_end - 1\nLEFT JOIN ${prefix}live.live_show_titles_start_end_ts\
  \ AS lst ON plf.title_id = lst.title_id\n WHERE  coalesce(alloc.is_tester, 0) =\
  \ 0 AND alloc_properties['is_copied'] IS NULL\n GROUP BY  obs_window.observation_window,\
  \ alloc.test_id, alloc.alloc_group_id, alloc.test_cell_nbr, alloc.account_id, IF(alloc.days_since_allocation\
  \ >= obs_window.window_end - 1, 1, 0), plf.title_id, lst.show_desc)\n\nUNION ALL\n\
  (SELECT  obs_window.observation_window,\n\talloc.test_id,\n\talloc.alloc_group_id,\n\
  \talloc.test_cell_nbr,\n\talloc.account_id,\n\tIF(alloc.days_since_allocation >=\
  \ obs_window.window_end - 1, 1, 0) AS is_window_complete,\n\tNULL AS title_id,\n\
  \tNULL AS show_desc,\n\tNULL AS live_content_viewing_secs,\n\tNULL AS live_plus_96h_content_viewing_secs,\n\
  \tNULL AS live_plus_168h_content_viewing_secs,\n\tNULL AS live_plus_28d_content_viewing_secs\n\
  \ FROM source.prodhive.exp_data.allocation_core_d AS alloc CROSS JOIN common.dimensions.xp.observation_window\
  \ obs_window\n WHERE  coalesce(alloc.is_tester, 0) = 0 AND alloc_properties['is_copied']\
  \ IS NULL)"
columns:
- name: title_id
  attributes:
  - dimension
- name: show_desc
  attributes:
  - dimension
primary_key: []
dimension_links:
- type: join
  dimension_node: common.dimensions.xp.observation_window
  join_type: left
  join_on: ${prefix}live.live_starters_viewing_secs_w_allocation.observation_window
    = common.dimensions.xp.observation_window.observation_window
- type: join
  dimension_node: common.dimensions.xp.ab_test
  join_type: left
  join_on: ${prefix}live.live_starters_viewing_secs_w_allocation.test_id = common.dimensions.xp.ab_test.test_id
- type: join
  dimension_node: common.dimensions.xp.ab_test_plan
  join_type: left
  join_on: ${prefix}live.live_starters_viewing_secs_w_allocation.alloc_group_id =
    common.dimensions.xp.ab_test_plan.group_id
- type: join
  dimension_node: common.dimensions.xp.ab_test_cell
  join_type: left
  join_on: ${prefix}live.live_starters_viewing_secs_w_allocation.test_cell_nbr = common.dimensions.xp.ab_test_cell.cell_id
- type: join
  dimension_node: common.dimensions.account
  join_type: left
  join_on: ${prefix}live.live_starters_viewing_secs_w_allocation.account_id = common.dimensions.account.account_id
- type: join
  dimension_node: common.dimensions.xp.is_window_complete
  join_type: left
  join_on: ${prefix}live.live_starters_viewing_secs_w_allocation.is_window_complete
    = common.dimensions.xp.is_window_complete.is_window_complete
tags:
- xp.report
