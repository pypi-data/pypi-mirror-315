/*! For license information please see 380.aee07c6f3b33966c93dc.js.LICENSE.txt */
"use strict";(self.webpackChunk_jupyterlite_terminal=self.webpackChunk_jupyterlite_terminal||[]).push([[380],{380:(t,e,s)=>{s.r(e),s.d(e,{Aliases:()=>r,BufferedOutput:()=>D,CommandRegistry:()=>R,ConsoleOutput:()=>B,Context:()=>L,ControlCharacter:()=>Nt,ExitCode:()=>n,FileInput:()=>W,FileOutput:()=>F,InputAll:()=>P,InputFlag:()=>Et,LocalFlag:()=>Ot,OutputFlag:()=>At,Pipe:()=>V,PipeInput:()=>M,RedirectOutput:()=>H,Shell:()=>It,TerminalInput:()=>U,TerminalOutput:()=>Q,Termios:()=>bt,parse:()=>q,tokenize:()=>$});var i={};s.r(i),s.d(i,{AliasCommand:()=>g,BuiltinCommand:()=>l,CdCommand:()=>m,ClearCommand:()=>N,CockleConfigCommand:()=>b,ExitCommand:()=>v,ExportCommand:()=>I,HistoryCommand:()=>k});class r extends Map{constructor(){super(),this.set("dir","dir --color=auto"),this.set("grep","grep --color=auto"),this.set("ls","ls --color=auto"),this.set("ll","ls -lF"),this.set("vdir","vdir --color=auto")}getRecursive(t){let e=this.get(t);for(;void 0!==e;){const s=e.split(" ")[0];if(s===t)break;const i=this.get(s);e=void 0===i?i:i+e.slice(s.length),t=s}return e}match(t){return[...this.keys()].filter((e=>e.startsWith(t)))}}const n={SUCCESS:0,GENERAL_ERROR:1,IMPROPER_USE:2,CANNOT_RUN_COMMAND:126,CANNOT_FIND_COMMAND:127};class a extends Error{exitCode;constructor(t,e){super(e),this.exitCode=t}}class o extends a{constructor(t){super(n.CANNOT_FIND_COMMAND,`'${t}': command not found`)}}class h extends a{constructor(t){super(n.GENERAL_ERROR,t)}}class l{names(){return[this.name]}run(t,e){if(t!==this.name)throw new o(t);return this._run(e)}}class c{shortName;longName;description;constructor(t,e,s){this.shortName=t,this.longName=e,this.description=s}get isSet(){return this._isSet}get name(){return this.shortName?this.shortName:this.longName}get prefixedName(){return this.shortName?`-${this.shortName}`:`--${this.longName}`}set(){this._isSet=!0}_isSet=!1}class u extends c{constructor(t,e,s){super(t,e,s)}}class d extends c{minCount;constructor(t=1){if(super("","",""),this.minCount=t,t<0)throw new h("Negative minCount in TrailingStringsOption.constructor")}add(t){this._strings.push(t),this._isSet=!0}get length(){return this._strings.length}get strings(){return this._strings}_strings=[]}class f{static fromArgs(t,e){const s=new e,i=s._getStrings();let r=!1;for(const e of t)if(e.startsWith("-")&&e.length>1){if(r)throw new h("Cannot have named option after parsing a trailing path");if(e.startsWith("--")){const t=e.slice(2);s._findByLongName(t).set()}else{const t=e.slice(1);s._findByShortName(t).set()}}else{if(null===i)throw new h(`Unrecognised option: ${e}`);i.add(e),r=!0}if(i&&i.length<i.minCount)throw new h("Insufficient trailing strings options specified");return s}writeHelp(t){for(const e of this._help())t.write(`${e}\n`)}_findByLongName(t){let e;for(e of Object.values(this))if(e.longName===t)return e;throw new h(`No such longName option '${t}'`)}_findByShortName(t){let e;for(e of Object.values(this))if(e.shortName===t)return e;throw new h(`No such shortName option '${t}'`)}_getStrings(){return"trailingStrings"in this?this.trailingStrings:null}_help(){return[...Object.values(this)].sort(((t,e)=>t.name>e.name?1:-1)).map((t=>{const e=t.prefixedName,s=Math.max(1,12-e.length);return`    ${e}${" ".repeat(s)}${t.description}`}))}}class _ extends f{trailingStrings=new d(0)}class g extends l{get name(){return"alias"}async _run(t){const{aliases:e,args:s,stdout:i}=t,r=f.fromArgs(s,_);if(r.trailingStrings.isSet)for(const t of r.trailingStrings.strings){const s=t.indexOf("=");-1===s?i.write(`${t}='${e.get(t)}'\n`):e.set(t.slice(0,s),t.slice(s+1))}else for(const[t,s]of e.entries())i.write(`${t}='${s}'\n`);return n.SUCCESS}}class p extends f{trailingStrings=new d(0)}class m extends l{get name(){return"cd"}async _run(t){const{args:e}=t,s=f.fromArgs(e,p).trailingStrings.strings;if(s.length<1)return n.SUCCESS;if(s.length>1)throw new h("cd: too many arguments");let i=s[0];if("-"===i){const e=t.environment.get("OLDPWD");if(void 0===e)throw new h("cd: OLDPWD not set");i=e,t.stdout.write(`${i}\n`)}const{FS:r}=t.fileSystem,a=r.cwd();return r.chdir(i),t.environment.set("OLDPWD",a),t.environment.set("PWD",r.cwd()),n.SUCCESS}}const C="[H",y="[2J",S="[3J",w="[1;0m",E="[0;94m",A="[0;95m",O="[0;32m";class N extends l{get name(){return"clear"}async _run(t){const{stdout:e}=t;return e.supportsAnsiEscapes()&&e.write(y+S+C),n.SUCCESS}}class b extends l{get name(){return"cockle-config"}async _run(t){const{stdout:e}=t;return e.write("cockle 0.0.12\n"),this._writePackageConfig(t),n.SUCCESS}_writePackageConfig(t){const{commandRegistry:e,stdout:s}=t,i=e.wasmPackageMap,r=[["package","version","build string","channel"]];for(const t of i.values())r.push([t.name,t.version,t.build_string,t.channel]);let n=null;s.supportsAnsiEscapes()&&(n=new Map,n.set(1,E),n.set(2,A),n.set(3,O));for(const t of function*(t,e,s=!1,i=null){const r=t.length,n=t[0].length,a=t.map((t=>t.map((t=>t.length)))),o=Array(n).fill(0);for(let t=0;t<r;t++)for(let e=0;e<n;e++)o[e]=Math.max(o[e],a[t][e]);function h(t){let e="â•­â”œâ•°"[t];for(let s=0;s<n;s++)e+="â”€".repeat(o[s]+2),e+=s<n-1?"â”¬â”¼â”´"[t]:"â•®â”¤â•¯"[t];return e}s||(yield h(0));for(let a=0;a<r;a++){const l=t[a];let c=s?"":"â”‚ ";for(let t=0;t<n;t++){const e=i?.get(t)||null;c+=e?e+l[t]+w:l[t],c+=" ".repeat(o[t]-l[t].length),c+=s?"  ":" â”‚ "}if(yield c,a===e-1)if(s){let t="";for(let e=0;e<n;e++)t+="â”€".repeat(o[e])+"  ";yield t}else a!==r-1&&(yield h(1))}s||(yield h(2))}(r,1,!1,n))s.write(t+"\n")}}class v extends l{get name(){return"exit"}async _run(t){const{stdout:e,terminate:s}=t;return e.write("Terminating shell...\n"),e.flush(),s(),n.SUCCESS}}class T extends f{trailingStrings=new d(0)}class I extends l{get name(){return"export"}async _run(t){const{args:e,environment:s}=t,i=f.fromArgs(e,T);if(i.trailingStrings.isSet)for(const t of i.trailingStrings.strings){const e=t.indexOf("=");if(e>0){const i=t.slice(0,e),r=t.slice(e+1);s.set(i,r)}}return n.SUCCESS}}class x extends f{clear=new u("c","","clear the history by deleting all of the entries");help=new u("","help","display this help and exit")}class k extends l{get name(){return"history"}async _run(t){const{args:e,history:s,stdout:i}=t,r=f.fromArgs(e,x);return r.help.isSet?r.writeHelp(i):r.clear.isSet?s.clear():s.write(i),n.SUCCESS}}class R{constructor(t){this.registerBuiltinCommands(i)}get(t){return this._map.get(t)??null}match(t){return[...this._map.keys()].filter((e=>e.startsWith(t))).sort()}registerBuiltinCommands(t){for(const[e,s]of Object.entries(t))if(e.endsWith("Command")&&!e.startsWith("Builtin"))try{const t=new s;t instanceof l&&this._register(t)}catch{}}registerWasmCommandPackage(t){this.wasmPackageMap.set(t.name,t);for(const e of t.modules)this._register(e)}_register(t){for(const e of t.names())this._map.set(e,t)}_map=new Map;wasmPackageMap=new Map}class L{args;fileSystem;mountpoint;aliases;commandRegistry;environment;history;terminate;stdin;stdout;stderr;bufferedIO;constructor(t,e,s,i,r,n,a,o,h,l,c,u){this.args=t,this.fileSystem=e,this.mountpoint=s,this.aliases=i,this.commandRegistry=r,this.environment=n,this.history=a,this.terminate=o,this.stdin=h,this.stdout=l,this.stderr=c,this.bufferedIO=u}flush(){this.stderr.flush(),this.stdout.flush()}}class D{get allContent(){return this.data.join("")}clear(){this.data=[]}supportsAnsiEscapes(){return!1}write(t){this.data.push(t)}data=[]}class B{flush(){}supportsAnsiEscapes(){return!1}write(t){console.log(t)}}class P{isTerminal(){return!1}readChar(){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const t=this._buffer[this._index++],e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}return[4]}_buffer;_index=0}class W extends P{fileSystem;path;constructor(t,e){super(),this.fileSystem=t,this.path=e}readAll(){const{FS:t}=this.fileSystem;return t.readFile(this.path,{encoding:"utf8"})}}class F extends D{fileSystem;path;append;constructor(t,e,s){super(),this.fileSystem=t,this.path=e,this.append=s}flush(){const{FS:t}=this.fileSystem;let e=this.allContent;if(this.append)try{e=t.readFile(this.path,{encoding:"utf8"})+e}catch(t){}t.writeFile(this.path,e,{mode:436}),this.clear()}}class M extends P{pipe;constructor(t){super(),this.pipe=t}readAll(){const t=this.pipe.allContent;return this.pipe.clear(),t}}class V extends D{flush(){}get input(){return new M(this)}}class H extends D{constructor(t){super(),this.target=t}flush(){this.data.forEach((t=>this.target.write(t))),this.clear(),this.target.flush()}target}class U{stdinCallback;constructor(t){this.stdinCallback=t}isTerminal(){return!0}readChar(){if(this._finished||void 0===this.stdinCallback)return[4];{const t=this.stdinCallback();if(4===t[0])this._finished=!0;else if(13===t[0])return[10];return t}}_finished=!1}class Q{outputCallback;prefix;suffix;constructor(t,e=null,s=null){this.outputCallback=t,this.prefix=e,this.suffix=s}flush(){}supportsAnsiEscapes(){return!0}write(t){t.length<1||(null!==this.prefix&&(t=this.prefix+t),null!==this.suffix&&(t+=this.suffix),this.outputCallback(t))}}function $(t,e=!0,s){const i=new z(t,e,s);return i.run(),i.tokens}var j;!function(t){t[t.None=0]="None",t[t.Delimiter=1]="Delimiter",t[t.DoubleQuote=2]="DoubleQuote",t[t.SingleQuote=3]="SingleQuote",t[t.Whitespace=4]="Whitespace",t[t.Other=5]="Other"}(j||(j={}));class z{throwErrors;aliases;constructor(t,e,s){this.throwErrors=e,this.aliases=s,this._source=t,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new h("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const t=this._offset,e=this._value;if(void 0!==this.aliases&&t!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const s=this.aliases.getRecursive(e);if(void 0!==s){const i=e.length;return this._offset=-1,this._index=t-1,this._aliasOffset=t,this._source=this._source.slice(0,t)+s+this._source.slice(t+i),this._prevChar="",this._prevCharType=j.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:t,value:e}),this._endQuote="",!0}_getCharType(t){return" ".includes(t)?j.Whitespace:";&|><".includes(t)?j.Delimiter:"'"===t?j.SingleQuote:'"'===t?j.DoubleQuote:j.Other}_endQuoteFromCharType(t){return t===j.DoubleQuote?'"':t===j.SingleQuote?"'":""}_next(){const t=++this._index,e=t<this._source.length?this._source[t]:" ";let s=this._getCharType(e);const i=this._endQuoteFromCharType(s);this._offset>=0?this._endQuote?e!==this._endQuote?this._value+=e:(this._endQuote="",s=j.Other):i?this._endQuote=i:s===j.Whitespace?this._addToken()&&(this._offset=-1):s!==this._prevCharType||s===j.Delimiter&&e!==this._prevChar?this._addToken()&&(this._offset=t,this._value=e):this._value+=e:s!==j.Whitespace&&(this._offset=t,this._endQuote=this._endQuoteFromCharType(s),this._value=""===this._endQuote?e:""),this._prevChar=e,this._prevCharType=s}_source;_tokens;_prevChar="";_prevCharType=j.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}const X=";&";class G{}class K extends G{name;suffix;redirects;constructor(t,e,s){super(),this.name=t,this.suffix=e,this.redirects=s}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class Y extends G{commands;constructor(t){super(),this.commands=t}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class J extends G{token;target;constructor(t,e){super(),this.token=t,this.target=e}lastToken(){return[this.target,!1]}}function q(t,e=!0,s){const i=$(t,e,s),r=[],n=[];let a=-1;const o=i.length;function h(){1===n.length?r.push(n[0]):n.length>1&&r.push(new Y([...n])),n.length=0}for(let t=0;t<o;t++){const e=i[t];a>=0?X.includes(e.value)?(n.push(Z(i.slice(a,t))),h(),a=-1):"|"===e.value&&(n.push(Z(i.slice(a,t))),a=-1):X.includes(e.value)||(a=t)}return a>=0&&n.push(Z(i.slice(a,o))),h(),r}function Z(t){let e=t.slice(1);const s=e.findIndex((t=>{return(e=t.value).startsWith(">")||e.startsWith("<");var e}));if(s>=0){if(e.length!==s+2)throw new h("Redirect should be followed by file to redirect to");const i=new J(e[s],e[s+1]);return e=e.slice(0,s),new K(t[0],e,[i])}return new K(t[0],e)}var tt=s(602);const et=Symbol("Comlink.proxy"),st=Symbol("Comlink.endpoint"),it=Symbol("Comlink.releaseProxy"),rt=Symbol("Comlink.finalizer"),nt=Symbol("Comlink.thrown"),at=t=>"object"==typeof t&&null!==t||"function"==typeof t,ot=new Map([["proxy",{canHandle:t=>at(t)&&t[et],serialize(t){const{port1:e,port2:s}=new MessageChannel;return ht(t,e),[s,[s]]},deserialize:t=>(t.start(),ct(t))}],["throw",{canHandle:t=>at(t)&&nt in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function ht(t,e=globalThis,s=["*"]){e.addEventListener("message",(function i(r){if(!r||!r.data)return;if(!function(t,e){for(const s of t){if(e===s||"*"===s)return!0;if(s instanceof RegExp&&s.test(e))return!0}return!1}(s,r.origin))return void console.warn(`Invalid origin '${r.origin}' for comlink proxy`);const{id:n,type:a,path:o}=Object.assign({path:[]},r.data),h=(r.data.argumentList||[]).map(St);let l;try{const e=o.slice(0,-1).reduce(((t,e)=>t[e]),t),s=o.reduce(((t,e)=>t[e]),t);switch(a){case"GET":l=s;break;case"SET":e[o.slice(-1)[0]]=St(r.data.value),l=!0;break;case"APPLY":l=s.apply(e,h);break;case"CONSTRUCT":l=Ct(new s(...h));break;case"ENDPOINT":{const{port1:e,port2:s}=new MessageChannel;ht(t,s),l=function(t,e){return mt.set(t,e),t}(e,[e])}break;case"RELEASE":l=void 0;break;default:return}}catch(t){l={value:t,[nt]:0}}Promise.resolve(l).catch((t=>({value:t,[nt]:0}))).then((s=>{const[r,o]=yt(s);e.postMessage(Object.assign(Object.assign({},r),{id:n}),o),"RELEASE"===a&&(e.removeEventListener("message",i),lt(e),rt in t&&"function"==typeof t[rt]&&t[rt]())})).catch((t=>{const[s,i]=yt({value:new TypeError("Unserializable return value"),[nt]:0});e.postMessage(Object.assign(Object.assign({},s),{id:n}),i)}))})),e.start&&e.start()}function lt(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function ct(t,e){return gt(t,[],e)}function ut(t){if(t)throw new Error("Proxy has been released and is not useable")}function dt(t){return wt(t,{type:"RELEASE"}).then((()=>{lt(t)}))}const ft=new WeakMap,_t="FinalizationRegistry"in globalThis&&new FinalizationRegistry((t=>{const e=(ft.get(t)||0)-1;ft.set(t,e),0===e&&dt(t)}));function gt(t,e=[],s=function(){}){let i=!1;const r=new Proxy(s,{get(s,n){if(ut(i),n===it)return()=>{!function(t){_t&&_t.unregister(t)}(r),dt(t),i=!0};if("then"===n){if(0===e.length)return{then:()=>r};const s=wt(t,{type:"GET",path:e.map((t=>t.toString()))}).then(St);return s.then.bind(s)}return gt(t,[...e,n])},set(s,r,n){ut(i);const[a,o]=yt(n);return wt(t,{type:"SET",path:[...e,r].map((t=>t.toString())),value:a},o).then(St)},apply(s,r,n){ut(i);const a=e[e.length-1];if(a===st)return wt(t,{type:"ENDPOINT"}).then(St);if("bind"===a)return gt(t,e.slice(0,-1));const[o,h]=pt(n);return wt(t,{type:"APPLY",path:e.map((t=>t.toString())),argumentList:o},h).then(St)},construct(s,r){ut(i);const[n,a]=pt(r);return wt(t,{type:"CONSTRUCT",path:e.map((t=>t.toString())),argumentList:n},a).then(St)}});return function(t,e){const s=(ft.get(e)||0)+1;ft.set(e,s),_t&&_t.register(t,e,t)}(r,t),r}function pt(t){const e=t.map(yt);return[e.map((t=>t[0])),(s=e.map((t=>t[1])),Array.prototype.concat.apply([],s))];var s}const mt=new WeakMap;function Ct(t){return Object.assign(t,{[et]:!0})}function yt(t){for(const[e,s]of ot)if(s.canHandle(t)){const[i,r]=s.serialize(t);return[{type:"HANDLER",name:e,value:i},r]}return[{type:"RAW",value:t},mt.get(t)||[]]}function St(t){switch(t.type){case"HANDLER":return ot.get(t.name).deserialize(t.value);case"RAW":return t.value}}function wt(t,e,s){return new Promise((i=>{const r=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");t.addEventListener("message",(function e(s){s.data&&s.data.id&&s.data.id===r&&(t.removeEventListener("message",e),i(s.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:r},e),s)}))}var Et,At,Ot,Nt;!function(t){t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8"}(Et||(Et={})),function(t){t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY"}(At||(At={})),function(t){t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN"}(Ot||(Ot={})),function(t){t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2"}(Nt||(Nt={}));class bt{clone(){return{c_iflag:this.c_iflag,c_oflag:this.c_oflag,c_cflag:this.c_cflag,c_lflag:this.c_lflag,c_cc:[...this.c_cc]}}log(){const t=(t,e,s)=>{const i=[];for(const[e,r]of Object.entries(t).filter((([t,e])=>t[0].match(/\D/))))(s&r)>0&&i.push(e);return`  ${e} = ${s} 0x${s.toString(16)} = ${i.join(" ")}`},e=["Termios:"];e.push(t(Et,"c_iflag",this.c_iflag)),e.push(t(At,"c_oflag",this.c_oflag)),e.push(`  c_cflag = ${this.c_cflag} 0x${this.c_cflag.toString(16)}`),e.push(t(Ot,"c_lflag",this.c_lflag)),e.push(`  c_cc = ${this.c_cc}`),console.log(e.join("\n"))}static newDefaultWasm(){const t=new bt;return t.setDefaultWasm(),t}set(t){this.c_iflag=t.c_iflag,this.c_oflag=t.c_oflag,this.c_cflag=t.c_cflag,this.c_lflag=t.c_lflag,this.c_cc=[...t.c_cc],this.log()}setDefaultWasm(){this.c_iflag=Et.IUTF8|Et.IMAXBEL|Et.IXON|Et.ICRNL,this.c_oflag=At.OPOST|At.ONLCR,this.c_cflag=191,this.c_lflag=Ot.IEXTEN|Ot.ECHOKE|Ot.ECHOCTL|Ot.ECHOK|Ot.ECHOE|Ot.ECHO|Ot.ICANON|Ot.ISIG,this.c_cc=[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.log()}c_iflag=0;c_oflag=0;c_cflag=0;c_lflag=0;c_cc=[]}class vt{constructor(t){const e=Int32Array.BYTES_PER_ELEMENT,s=this._maxReadChars+3,i=this._maxWriteChars+2,r=s+i;this._sharedArrayBuffer=void 0===t?new SharedArrayBuffer(r*e):t,this._readArray=new Int32Array(this._sharedArrayBuffer,0,s),void 0===t&&(this._readArray[0]=0,this._readArray[1]=0),this._writeArray=new Int32Array(this._sharedArrayBuffer,s*e,i),void 0!==t&&(this._writeArray[0]=0,this._writeArray[1]=0)}async disable(){this._enabled=!1,this._clear()}async enable(){this._enabled=!0}get enabled(){return this._enabled}utf8ArrayToString(t){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(t)}_clear(){this._readArray[0]=0,this._readArray[1]=0,this._readCount=0}_loadFromSharedArrayBuffer(){const t=Atomics.load(this._readArray,2),e=[];for(let s=0;s<t;s++)e.push(Atomics.load(this._readArray,3+s));return e}_enabled=!1;_sharedArrayBuffer;_maxReadChars=64;_readArray;_readCount=0;_maxWriteChars=256;_writeArray;_utf8Decoder}class Tt extends vt{outputCallback;constructor(t){super(),this.outputCallback=t}async disable(){if(this._disabling=!0,this._readSentCount!==this._readCount){const t=this._loadFromSharedArrayBuffer();let e="";for(const s of t)e+=String.fromCharCode(s);await this._sendStdinNow(e)}for(;this._readBuffer.length>0;)await this._sendStdinNow(this._readBuffer.shift());this._disabling=!1,super.disable()}dispose(){this._isDisposed||(this._disposing=!0,Atomics.store(this._writeArray,0,999),Atomics.notify(this._writeArray,0),this._isDisposed=!0)}get sharedArrayBuffer(){return this._sharedArrayBuffer}async push(t){this._readBuffer.push(t),this._readBufferCount++,t.length>this._maxReadChars&&console.log(`String '${t}' is too long to buffer`),this._disabling||this._readCount!==this._readSentCount||this._storeInSharedArrayBuffer()}registerSendStdinNow(t){this._sendStdinNow=t}async start(){this._listenForWrite()}async _afterListenWrite(){let t="",e=!0;do{let s=Atomics.load(this._writeArray,1);e=0===s,e&&(s=this._maxWriteChars);const i=new Int16Array(s);for(let t=0;t<s;t++)i[t]=Atomics.load(this._writeArray,2+t);t+=String.fromCharCode(...i),!e&&t.length>0&&!this._disposing&&this.outputCallback(t),Atomics.store(this._writeArray,0,0),Atomics.notify(this._writeArray,0,1),e&&!this._disposing&&await Atomics.waitAsync(this._writeArray,0,0).value}while(e);this._disposing||this._listenForWrite()}_afterRead(){if(this._readCount=Atomics.load(this._readArray,1),this._readCount!==this._readSentCount)throw new Error("Should not happen");this._readBufferCount>this._readSentCount&&this._storeInSharedArrayBuffer()}_clear(){super._clear(),this._readBuffer=[],this._readBufferCount=0,this._readSentCount=0}_listenForWrite(){const{async:t,value:e}=Atomics.waitAsync(this._writeArray,0,0);t&&e.then((()=>{this._disabling||this._afterListenWrite()}))}_storeInSharedArrayBuffer(){const t=this._readBuffer.shift();this._readSentCount++;const e=t.length;Atomics.store(this._readArray,2,e);for(let s=0;s<e;s++)Atomics.store(this._readArray,3+s,t.charCodeAt(s));Atomics.store(this._readArray,0,this._readSentCount),Atomics.notify(this._readArray,0,1);const{async:s,value:i}=Atomics.waitAsync(this._readArray,1,this._readCount);s&&i.then((()=>this._afterRead()))}_disposing=!1;_isDisposed=!1;_disabling=!1;_readBuffer=[];_readBufferCount=0;_readSentCount=0;_sendStdinNow}class It{options;constructor(t){this.options=t,this._bufferedIO=new Tt(t.outputCallback),this._initWorker(t)}async _initWorker(t){this._worker=new Worker(new URL(s.p+s.u(817),s.b),{type:void 0}),this._remote=ct(this._worker);const{mountpoint:e,wasmBaseUrl:i,driveFsBaseUrl:r,initialDirectories:n,initialFiles:a}=t,{sharedArrayBuffer:o}=this._bufferedIO;await this._remote.initialize({color:t.color??!0,mountpoint:e,wasmBaseUrl:i,driveFsBaseUrl:r,sharedArrayBuffer:o,initialDirectories:n,initialFiles:a},Ct(this.enableBufferedStdinCallback.bind(this)),Ct(this.dispose.bind(this))),this._bufferedIO.registerSendStdinNow(this._remote.input)}dispose(){this._isDisposed||(console.log("Shell.dispose"),this._isDisposed=!0,this._remote=void 0,this._worker.terminate(),this._worker=void 0,this._bufferedIO.dispose(),this._bufferedIO=void 0,this._disposed.emit())}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}async enableBufferedStdinCallback(t){this.isDisposed||(t?await this._bufferedIO.enable():await this._bufferedIO.disable())}async input(t){this.isDisposed||(this._bufferedIO.enabled?await this._bufferedIO.push(t):await this._remote.input(t))}async setSize(t,e){this.isDisposed||await this._remote.setSize(t,e)}async start(){this.isDisposed||(await this._bufferedIO.start(),await this._remote.start())}_worker;_remote;_bufferedIO;_disposed=new tt.Signal(this);_isDisposed=!1}}}]);